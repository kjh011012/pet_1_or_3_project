# whoosh.py
from whoosh.index import create_in, open_dir
from whoosh.fields import Schema, TEXT
from whoosh.qparser import QueryParser, WildcardPlugin
import os

# 스키마 정의 및 인덱스 초기화
schema = Schema(title=TEXT(stored=True), content=TEXT(stored=True))
index_dir = "indexdir"

# 인덱스 디렉토리 생성
if not os.path.exists(index_dir):
    os.mkdir(index_dir)
ix = create_in(index_dir, schema)

# 텍스트 데이터 인덱싱 함수

def index_data(data):
    writer = ix.writer()
    for entry in data:
        writer.add_document(title=entry["title"], content=entry["content"])
        print(f"Indexed: {entry['title']}")
    writer.commit()


# 초기 텍스트 데이터 (필요에 따라 추가 가능)
wiki_data = [
    {
        "title": "등록대상동물의 범위는?",
        "content": "동물보호법 시행령 제4조에 따라 2개월 이상의 개로서 주택, 준주택에서 기르거나 주택 외의 장소에서 반려목적으로 기르는 경우가 등록대상입니다. 고양이는 동물등록 시범사업 중으로 내장형으로만 등록 가능합니다."
    },
    {
        "title": "해외에서 내장형 무선식별장치가 시술된 반려견에 대해 등록신청 하는 경우는?",
        "content": "동물보호법 시행령 별표1에 맞는 규격일 경우 그 번호는 등록 가능하며, 국가동물보호정보시스템에서 해당 동물이 적법하게 입국했는지 확인 후 등록 가능합니다. 조회가 되지 않으면 상대국 검역증명서나 마이크로칩 이식 확인서를 제출해야 합니다."
    },
    {
        "title": "동물등록신청은 어디서 하나요?",
        "content": "동물등록 대행업체(주로 동물병원)에서 신청 가능합니다. 국가동물보호정보시스템에서 가까운 등록대행업체를 검색할 수 있으며, 각 지자체 조례에 따라 등록 대행업체에서만 등록이 가능할 수 있습니다."
    },
    {
        "title": "동물등록증 출력은 어떻게 하나요?",
        "content": "국가동물보호정보시스템에서 회원가입 후, 회원정보수정에서 주민등록번호를 입력하고 수정 버튼을 누른 후, MyPage의 등록동물 정보에서 출력 버튼을 누르면 됩니다."
    },
    {
        "title": "소유자가 변경된 경우 어떻게 하나요?",
        "content": "등록대상동물의 소유권을 이전받은 사람은 소유권을 이전받은 날로부터 30일 이내에 시군구에 변경신고를 해야 합니다."
    },
    {
        "title": "등록신청 후 처리기간은 얼마나 걸리나요?",
        "content": "동물등록 신청 후 대행업체에서 소유자가 작성한 신청서를 제출하면 시군구청에 송부되며, 각 지자체에서 확인 후 최종 승인됩니다."
    },
    {
        "title": "소유자의 주소가 변경된 경우 어떻게 하나요?",
        "content": "등록동물의 소유자는 주소 변경 시 30일 이내에 시군구에 신고해야 합니다. 국가동물보호정보시스템에서 온라인으로 변경하거나, 지자체에 변경신고서를 제출할 수 있습니다."
    },
    {
        "title": "등록할 때 본인이 가지 않아도 등록할 수 있나요?",
        "content": "가능합니다. 위임장, 신청서, 기타 필요서류를 작성하여 다른 사람에게 위임할 수 있으나, 신규 등록 시 동물을 데리고 가야 하므로 소유자가 직접 신청하는 것이 좋습니다."
    },
    {
        "title": "동물등록신청서 서식은 어디에 있나요?",
        "content": "동물등록 신청서 및 변경신고서는 동물보호법 안내에서 시행규칙 별지 서식을 사용할 수 있으며, 대행업체나 지자체에서도 구비되어 있습니다."
    },
    {
        "title": "동물등록제란 무엇인가요?",
        "content": "동물등록제는 반려동물의 등록을 통해 소유주의 책임을 강화하고, 유실동물의 신속한 인계를 돕기 위해 마련된 제도입니다. 이를 통해 동물보호와 전염병 예방을 목표로 합니다."
    },
    {
        "title": "소유자가 주소를 변경했을 경우 국가동물보호정보시스템에서 수정하는 방법은?",
        "content": "국가동물보호정보시스템에 가입 후, 회원정보수정에서 주민등록번호 13자리를 입력하고 저장한 후, MyPage에서 주소를 변경할 수 있습니다."
    },
    {
        "title": "동물의 품종과 성별이 잘못 입력된 경우 어떻게 하나요?",
        "content": "지자체 동물보호 담당자에게 문의하여 정정 요청을 할 수 있습니다."
    },
    {
        "title": "국가동물보호정보시스템에 RFID번호 체계가 맞지 않는다고 나오는 경우?",
        "content": "반려동물 등록에 사용하는 RFID번호는 국제표준코드 15자리를 준수해야 합니다. 규정에 맞지 않는 칩은 등록할 수 없으므로 지정 대행업체를 방문해 규격에 맞는 마이크로칩을 이식 후 등록해야 합니다."
    },
    {
        "title": "길고양이도 동물보호법의 보호대상인가요?",
        "content": "그렇습니다. 구조보호조치 제외 동물인 길고양이도 포획, 상해, 살해 등 학대행위는 금지됩니다."
    },
    {
        "title": "다른 지역 시군구에서도 동물등록 신청이 가능한가요?",
        "content": "관할 시군구청에 신청하는 것이 원칙이나, 타 지역에서도 동물등록을 처리할 수 있으며 등록증을 발급받을 수 있습니다."
    },
    {
        "title": "동물등록 관련 수수료는 어떻게 되나요?",
        "content": "내장형 무선식별장치 삽입 시 1만원, 외장형 장치 또는 등록인식표는 3천원의 수수료가 부과됩니다. 변경신고 수수료는 무료입니다."
    },
    {
        "title": "외장형 무선식별장치로 동물등록 시 병원을 방문해야 하나요?",
        "content": "무선식별장치 장착 및 확인을 위해 소유자는 반려견을 대행기관에 데리고 가야 합니다."
    },
    {
        "title": "소유권 변경 시 필요한 서류는 무엇인가요?",
        "content": "소유권 변경 후 30일 이내에 변경신고서와 동물등록증을 첨부하여 시군구청에 신고해야 합니다."
    },
    {
        "title": "광견병 예방접종 기록은 어디에 입력하나요?",
        "content": "동물등록번호로 접종 기록을 조회하여 누적 관리하며, 등록 전 기록도 포함해 기록할 수 있습니다."
    },
    {
        "title": "동물판매업소에서 판매를 위해 기르는 강아지도 등록대상인가요?",
        "content": "2개월 이상인 개가 반려를 목적으로 판매되는 경우, 구매자 명의로 등록 후 판매해야 합니다."
    },
    {
        "title": "국가동물보호정보시스템에서 소유자가 변경신고를 할 수 있나요?",
        "content": "소유자는 국가동물보호정보시스템에서 전화번호, 주소 변경 등을 신고할 수 있으며 관련 서류를 제출해야 합니다."
    },
    {
        "title": "무선식별장치는 어디서 구입할 수 있나요?",
        "content": "소유자가 선택해 구매할 수 있으며 주로 동물병원 등에 비치되어 있습니다. 국가동물보호정보시스템에서도 구매 가능 업체를 확인할 수 있습니다."
    },
    {
        "title": "동물등록증은 어떻게 출력해야 하나요?",
        "content": "국가동물보호정보시스템에 회원가입 후 로그인을 통해 출력할 수 있습니다."
    },
    {
        "title": "외장형 무선식별장치 분실 시 내장형으로 교체해야 하나요?",
        "content": "새로운 등록번호로 재등록해야 하며, 기존 번호는 재사용할 수 없습니다."
    },
    {
        "title": "동물등록대행기관에서 지번주소로 등록한 경우 어떻게 해야 하나요?",
        "content": "도로명주소 사용이 의무화되었으므로 소유자에게 도로명주소로 등록할 것을 안내해야 합니다."
    },
    {
        "title": "내장형 무선식별장치로 등록하면 인식표 부착을 안 해도 되나요?",
        "content": "마이크로칩 여부와 관계없이 소유자의 연락처 등이 표시된 인식표는 부착해야 합니다."
    },
    {
        "title": "동물등록 시 소유자 정보가 변경되면 어떻게 해야 하나요?",
        "content": "변경된 소유자는 변경신고서를 시군구청에 제출하여야 하며, 소유자 연락처나 주소 변경 시에도 동일합니다."
    },
    {
        "title": "동물등록 인식표는 어디서 부착해야 하나요?",
        "content": "소유자가 인식표를 구매하여 부착하며, 인식표에는 소유자의 이름, 연락처, 등록번호가 포함되어야 합니다."
    },
    {
        "title": "동물등록을 하지 않은 소유자가 병원을 방문한 경우는?",
        "content": "동물등록제를 설명하고 등록을 권고해야 합니다."
    },
    {
        "title": "야생동물 출몰 신고시 담당 부서는 어디인가요?",
        "content": "각 지자체 환경보호과 또는 야생생물 보호 및 관리에 관한 법률 담당 부서로 신고하면 됩니다."
    },
    {
        "title": "동물등록을 신청했는데 아직 승인 대기중이라면?",
        "content": "해당 지자체에서 승인 중이므로 관할 지자체에 문의하시기 바랍니다."
    },
    {
        "title": "마이크로칩 부작용 발생시 어디에 문의해야 하나요?",
        "content": "마이크로칩 시술을 담당한 대행업체에 문의하여 대처 방안을 찾으세요."
    },
    {
        "title": "외장형 무선식별장치 분실 시 수수료를 다시 내야 하나요?",
        "content": "새로운 장치를 등록할 때는 수수료를 다시 내야 합니다."
    },
    {
        "title": "고양이를 해외로 데리고 가려면 등록해야 하나요?",
        "content": "반드시 등록할 필요는 없으나, 마이크로칩 이식 여부를 확인해야 하며 출발지 검역본부에 문의하는 것이 좋습니다."
    },
    {
        "title": "유기동물을 데려다 키우면 법적으로 처벌을 받나요?",
        "content": "유기동물을 발견한 경우 신고 절차를 거쳐야 하며, 신고 없이 임의로 데려다 키우면 처벌을 받을 수 있습니다."
    },
    {
        "title": "아픈 새끼고양이를 발견했을 때 어떻게 해야 하나요?",
        "content": "다친 고양이의 경우 TNR 대상이 아니므로 동물보호센터에 신고해 보호받을 수 있도록 합니다."
    },
    {
        "title": "고양이는 언제 등록대상에 포함되나요?",
        "content": "고양이는 시범사업 중으로 내장형 등록이 가능합니다."
    }
]


# 텍스트 데이터 인덱싱 (필요할 때 호출)
index_data(wiki_data)

# 검색 함수
def search_related_content(query):
    ix = open_dir(index_dir)
    with ix.searcher() as searcher:
        parser = QueryParser("content", ix.schema)
        parser.add_plugin(WildcardPlugin())
        q = parser.parse(f"{query}*")
        results = searcher.search(q, limit=5)
        return [result['content'] for result in results] if results else []
# 키워드 추출 함수
def extract_keyword(question):
    if "강아지" in question or "야생동물" in question or "고양이" in question:
        return "동물보호"
    elif "등록" in question:
        return "등록"
    elif "신청" in question:
        return "신청"
    return question